<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Удмурт кыл</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Noto+Serif:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="ornament-top"></div>
    <div class="ornament-bottom"></div>

    <div class="counter">серия: <span id="streak">0</span></div>
    <div class="learned-words" id="learnedWords"></div>

    <div class="container">
      <div class="word-display fade-in" id="word">...</div>
      <div class="accent-line" id="accent"></div>

      <div class="input-wrap">
        <input
          type="text"
          id="answer"
          placeholder="удмурт кылын"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        />
      </div>

      <div class="button-group">
        <button id="checkBtn">Проверка</button>
        <button id="learnedBtn">Выучил(а)!</button>
      </div>

      <div class="feedback" id="feedback"></div>
    </div>

    <div class="control-buttons">
      <button id="helpBtn">Как учить?</button>
      <button id="saveBtn">Сохранить</button>
      <button id="loadBtn">Загрузить</button>
      <button id="resetBtn">Сбросить прогресс</button>
    </div>
    <input type="file" id="csvInput" accept=".csv" style="display: none" />

    <script>
      const STORAGE_KEY = "udmurt_learned_words";

      // Russian → Udmurt
      const dict = {
        я: "мон",
        дочь: "ныл",
        сын: "пи",
        русский: "ӟуч",
        каша: "ӝук",
        татарин: "бигер",
        сорока: "коӵо",
        дверь: "ӧс",
        кузнечик: "ӟоз",
        нет: "ӧвӧл",
        хорошо: "умой",
        рожь: "ӟег",
        ты: "тон",
        он: "со",
        любовь: "яратон",
        мы: "ми",
        кошка: "коӵыш",
        вы: "тӥ",
        утка: "ӵӧж",
        стол: "ӝӧк",
        варежка: "пӧзь",
        собака: "пуны",
        вода: "ву",
        глаз: "син",
        нос: "ныр",
        пыль: "тузон",
        они: "соос",
        круг: "котырет",
        паук: "чонари",
        платок: "кышет",
        "Доброе утро": "Бур ӵукнаен",
        молоко: "йӧл",
        хлеб: "нянь",
        луна: "толэзь",
        солнце: "шунды",
        звезда: "кизили",
        "Добрый день": "Бур нуналэн",
      };

      const keys = Object.keys(dict);
      let currentWord = "";
      let streak = 0;
      let feedbackTimer = null;
      let nextTimer = null;
      let waitingForKeyAfterWrongAnswer = false;



      // --- localStorage: загружаем сохранённые слова ---
      function loadLearnedWords() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          return saved ? new Set(JSON.parse(saved)) : new Set();
        } catch (e) {
          return new Set();
        }
      }

      function saveLearnedWords() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify([...learnedWords]));
        } catch (e) {
          console.warn("Не удалось сохранить прогресс:", e);
        }
      }

      // Новая функция для обновления текста в правом верхнем углу
      function updateCounterText() {
        const counterElement = document.querySelector(".counter");
        if (counterElement) {
          const totalWords = Object.keys(dict).length;
          const learnedCount = learnedWords.size;
          counterElement.textContent = `я знаю ${learnedCount} из ${totalWords}`;
        }
      }

      let learnedWords = loadLearnedWords();

      const wordEl = document.getElementById("word");
      const answerEl = document.getElementById("answer");
      const feedbackEl = document.getElementById("feedback");
      const checkBtn = document.getElementById("checkBtn");
      const learnedBtn = document.getElementById("learnedBtn");
      const streakEl = document.getElementById("streak");
      const accentEl = document.getElementById("accent");
      const learnedWordsContainerEl = document.getElementById("learnedWords");
      const resetBtn = document.getElementById("resetBtn");

      // --- Восстанавливаем отображение выученных слов ---
      function restoreLearnedWordsDisplay() {
        learnedWordsContainerEl.innerHTML = "";
        for (const word of learnedWords) {
          const wordSpan = document.createElement("span");
          wordSpan.className = "learned-word";
          wordSpan.textContent = dict[word];
          learnedWordsContainerEl.appendChild(wordSpan);
        }
        updateCounterText();
      }

      function getAvailableWords() {
        return keys.filter((k) => !learnedWords.has(k));
      }

      function pickWord(exclude) {
        const available = getAvailableWords().filter((k) => k !== exclude);
        if (available.length === 0) return null;
        return available[Math.floor(Math.random() * available.length)];
      }

      function showNoWordsMessage() {
        wordEl.classList.add("fade-out");
        setTimeout(() => {
          wordEl.textContent = "нет слов";
          wordEl.classList.remove("fade-out");
          void wordEl.offsetWidth;
          wordEl.classList.add("fade-in");
        }, 260);
        answerEl.disabled = true;
        checkBtn.disabled = true;
        learnedBtn.disabled = true;
      }

      function showWord(word) {
        wordEl.classList.add("fade-out");
        setTimeout(() => {
          wordEl.textContent = word;
          wordEl.classList.remove("fade-out");
          wordEl.classList.remove("fade-in");
          void wordEl.offsetWidth;
          wordEl.classList.add("fade-in");
        }, 260);
      }

      function nextRound() {
        const next = pickWord(currentWord);
        if (next === null) {
          showNoWordsMessage();
          return;
        }
        currentWord = next;
        showWord(currentWord);
        answerEl.value = "";
        answerEl.classList.remove("correct", "wrong");
        answerEl.disabled = false;
        clearFeedback();
        answerEl.focus();
      }

      function clearFeedback() {
        feedbackEl.classList.remove("visible", "wrong-text");
        feedbackEl.textContent = "";
      }

      function showFeedback(text, isWrong = false) {
        clearTimeout(feedbackTimer);
        clearTimeout(nextTimer);
        feedbackEl.textContent = text;
        feedbackEl.classList.toggle("wrong-text", isWrong);
        void feedbackEl.offsetWidth;
        feedbackEl.classList.add("visible");
      }

      function check() {
        const input = answerEl.value.trim().toLowerCase();
        const correct = dict[currentWord];

        if (!input) {
          answerEl.focus();
          return;
        }

        if (input === correct) {
          streak++;
          streakEl.textContent = streak;
          answerEl.classList.add("correct");
          answerEl.disabled = true;
          showFeedback("Ӟечок!");
          accentEl.style.width = "120px";
          waitingForKeyAfterWrongAnswer = false;
          removeWrongAnswerListeners();
          nextTimer = setTimeout(() => {
            accentEl.style.width = "60px";
            nextRound();
          }, 1800);
        } else {
          streak = 0;
          streakEl.textContent = streak;
          answerEl.classList.add("wrong");
          answerEl.disabled = true;
          showFeedback(`${correct}`, true);
          setTimeout(() => answerEl.classList.remove("wrong"), 400);
          // Добавляем слушатель с задержкой, чтобы текущее событие не прошло на document
          waitingForKeyAfterWrongAnswer = false;
          setTimeout(() => {
            waitingForKeyAfterWrongAnswer = true;
            addWrongAnswerListeners();
          }, 50);
        }
      }

      function removeWrongAnswerListeners() {
        document.removeEventListener("keydown", handleWrongAnswerKey);
        document.removeEventListener("touchstart", handleWrongAnswerTouch);
      }

      function addWrongAnswerListeners() {
        document.addEventListener("keydown", handleWrongAnswerKey);
        document.addEventListener("touchstart", handleWrongAnswerTouch);
      }

      function handleWrongAnswerKey() {
        if (!waitingForKeyAfterWrongAnswer) return;
        waitingForKeyAfterWrongAnswer = false;
        removeWrongAnswerListeners();
        clearTimeout(feedbackTimer);
        nextRound();
      }

      function handleWrongAnswerTouch() {
        if (!waitingForKeyAfterWrongAnswer) return;
        waitingForKeyAfterWrongAnswer = false;
        removeWrongAnswerListeners();
        clearTimeout(feedbackTimer);
        nextRound();
      }

      checkBtn.addEventListener("click", check);
      answerEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") check();
      });

      function markLearned() {
        const answerValue = answerEl.value.trim().toLowerCase();
        const correct = dict[currentWord];

        if (answerValue && answerValue === correct) {
          // Очищаем все ожидающие таймеры перед переходом на новое слово
          clearTimeout(feedbackTimer);
          clearTimeout(nextTimer);

          // Если поле заполнено и ответ правильный - добавляем в выученные слова
          learnedWords.add(currentWord);
          saveLearnedWords(); // ← сохраняем в localStorage

          const wordSpan = document.createElement("span");
          wordSpan.className = "learned-word";
          wordSpan.textContent = dict[currentWord];
          learnedWordsContainerEl.appendChild(wordSpan);

          updateCounterText();
          nextRound();
        } else {
          // Если поле пусто или ответ неправильный - показываем prompt
          const input = prompt("Пожалуйста, введите слово");

          if (input === null) return;

          if (input.trim().toLowerCase() === correct) {
            learnedWords.add(currentWord);
            saveLearnedWords(); // ← сохраняем в localStorage

            const wordSpan = document.createElement("span");
            wordSpan.className = "learned-word";
            wordSpan.textContent = dict[currentWord];
            learnedWordsContainerEl.appendChild(wordSpan);

            updateCounterText();
            nextRound();
          }
        }
      }

      learnedBtn.addEventListener("click", markLearned);

      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "Enter") {
          e.preventDefault();
          markLearned();
        }
      });

      // --- Сброс прогресса ---
      resetBtn.addEventListener("click", () => {
        if (confirm("Сбросить весь прогресс? Все выученные слова вернутся.")) {
          localStorage.removeItem(STORAGE_KEY);
          learnedWords = new Set();
          learnedWordsContainerEl.innerHTML = "";
          answerEl.disabled = false;
          checkBtn.disabled = false;
          learnedBtn.disabled = false;
          updateCounterText();
          nextRound();
        }
      });

      // --- Справка "Как учить?" ---
      const helpBtn = document.getElementById("helpBtn");
      helpBtn.addEventListener("click", () => {
        alert(
          "Вам нужно ввести слово на удмурт кылын - т.е. на удмуртском языке. Если вы не знаете слово, то введите любой текст, например 1 и нажмите проверить. Если вы точно уже знаете слово нажмите я выучил(а). Чтобы сохранить список выученных слов в EXCEL нажмите сохранить",
        );
      });

      // --- Сохранение в CSV ---
      const saveBtn = document.getElementById("saveBtn");
      saveBtn.addEventListener("click", () => {
        if (learnedWords.size === 0) {
          alert("Нет выученных слов для сохранения");
          return;
        }

        // Форматируем дату
        const today = new Date();
        const day = String(today.getDate()).padStart(2, "0");
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const year = today.getFullYear();
        const dateStr = `${day}_${month}_${year}`;
        const filename = `${dateStr}_my_words_${learnedWords.size}.csv`;

        // Добавляем BOM для корректного отображения UTF-8 в Excel
        let csv = "\uFEFF";
        csv += "Russian,Udmurt\n";
        for (const word of learnedWords) {
          csv += `"${word}","${dict[word]}"\n`;
        }

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      // --- Загрузка из CSV ---
      const loadBtn = document.getElementById("loadBtn");
      const csvInput = document.getElementById("csvInput");

      loadBtn.addEventListener("click", () => {
        csvInput.click();
      });

      csvInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const csv = event.target.result;
            const lines = csv.trim().split("\n");

            let addedCount = 0;
            for (let i = 1; i < lines.length; i++) {
              if (!lines[i].trim()) continue;

              const matches = lines[i].match(/"([^"]*)","([^"]*)"/);
              if (matches) {
                const russianWord = matches[1].toLowerCase();
                if (dict[russianWord]) {
                  learnedWords.add(russianWord);
                  addedCount++;
                }
              }
            }

            if (addedCount > 0) {
              saveLearnedWords();
              restoreLearnedWordsDisplay();
              updateCounterText();
              nextRound();
              alert(`Загружено ${addedCount} слов`);
            } else {
              alert("Не найдено известных слов в файле");
            }
          } catch (error) {
            alert("Ошибка при загрузке файла: " + error.message);
          }
        };
        reader.readAsText(file, "utf-8");
        csvInput.value = "";
      });

      // init
      restoreLearnedWordsDisplay();
      const available = getAvailableWords();
      if (available.length > 0) {
        currentWord = available[Math.floor(Math.random() * available.length)];
        wordEl.textContent = currentWord;
      } else {
        showNoWordsMessage();
      }
      answerEl.focus();
    </script>
  </body>
</html>
